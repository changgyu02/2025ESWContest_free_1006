import rclpy
from rclpy.node import Node
from std_msgs.msg import Bool
from std_srvs.srv import Trigger, SetBool


class TableManagerNode(Node):
    def __init__(self):
        super().__init__('table_manager_node')

        # âœ… êµ¬ë…ì: ì£¼í–‰ ì™„ë£Œ ì‹ í˜¸
        self.drive_done_sub = self.create_subscription(
            Bool,
            '/drive_done',
            self.drive_done_callback,
            10
        )

        # âœ… ì„œë¹„ìŠ¤ í´ë¼ì´ì–¸íŠ¸ ì„ ì–¸
        self.align_client = self.create_client(Trigger, 'table_align_service')
        self.cleaning_client = self.create_client(Trigger, 'table_cleaning_service')
        self.dirt_check_client = self.create_client(SetBool, 'dirt_check_service')
        self.go_home_client = self.create_client(Trigger, 'go_home')

        self.get_logger().info('âœ… Table Manager Node initialized.')

    # âœ… ì£¼í–‰ ì™„ë£Œ í† í”½ ìˆ˜ì‹  ì‹œ ì „ì²´ ì‹œí€€ìŠ¤ ì‹¤í–‰
    def drive_done_callback(self, msg):
        if not msg.data:
            return

        self.get_logger().info('ğŸš— ì£¼í–‰ ì™„ë£Œ ê°ì§€ë¨. í…Œì´ë¸” ì •ë ¬ ë° í´ë¦¬ë‹ ì‹œí€€ìŠ¤ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.')
        self.run_sequence()

    # âœ… ì „ì²´ ì‹œí€€ìŠ¤: ì •ë ¬ â†’ í´ë¦¬ë‹ â†’ íŒë‹¨ â†’ ì¬ì²­ì†Œ â†’ ë³µê·€
    def run_sequence(self):
        if not self.call_align_service():
            return

        if not self.call_cleaning_service():
            return

        dirty = self.call_dirt_check_service()
        if dirty:
            self.get_logger().info('ğŸŸ  í…Œì´ë¸”ì´ ì—¬ì „íˆ ë”ëŸ½ìŠµë‹ˆë‹¤. í•œ ë²ˆ ë” í´ë¦¬ë‹ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.')
            if not self.call_cleaning_service():
                return

        self.call_go_home_service()

    # âœ… í…Œì´ë¸” ì •ë ¬ ì„œë¹„ìŠ¤ í˜¸ì¶œ
    def call_align_service(self):
        if not self.align_client.wait_for_service(timeout_sec=3.0):
            self.get_logger().error('âŒ ì •ë ¬ ì„œë¹„ìŠ¤ ì—°ê²° ì‹¤íŒ¨.')
            return False

        request = Trigger.Request()
        future = self.align_client.call_async(request)
        rclpy.spin_until_future_complete(self, future)

        if future.result() is not None:
            self.get_logger().info(f'ğŸ“ í…Œì´ë¸” ì •ë ¬ ì™„ë£Œ: {future.result().message}')
            return future.result().success
        else:
            self.get_logger().error('âŒ ì •ë ¬ ìš”ì²­ ì‹¤íŒ¨.')
            return False

    # âœ… í´ë¦¬ë‹ ì„œë¹„ìŠ¤ í˜¸ì¶œ
    def call_cleaning_service(self):
        if not self.cleaning_client.wait_for_service(timeout_sec=3.0):
            self.get_logger().error('âŒ í´ë¦¬ë‹ ì„œë¹„ìŠ¤ ì—°ê²° ì‹¤íŒ¨.')
            return False

        request = Trigger.Request()
        future = self.cleaning_client.call_async(request)
        rclpy.spin_until_future_complete(self, future)

        if future.result() is not None:
            self.get_logger().info('âœ… í´ë¦¬ë‹ ì™„ë£Œ.')
            return future.result().success
        else:
            self.get_logger().error('âŒ í´ë¦¬ë‹ ìš”ì²­ ì‹¤íŒ¨.')
            return False

    # âœ… ì˜¤ì—¼ë„ íŒë‹¨ ì„œë¹„ìŠ¤ í˜¸ì¶œ
    def call_dirt_check_service(self):
        if not self.dirt_check_client.wait_for_service(timeout_sec=3.0):
            self.get_logger().error('âŒ ì˜¤ì—¼ë„ íŒë‹¨ ì„œë¹„ìŠ¤ ì—°ê²° ì‹¤íŒ¨.')
            return False

        request = SetBool.Request()
        request.data = True
        future = self.dirt_check_client.call_async(request)
        rclpy.spin_until_future_complete(self, future)

        if future.result() is not None:
            is_dirty = future.result().success
            self.get_logger().info(f'ğŸ” ì˜¤ì—¼ë„ íŒë‹¨ ê²°ê³¼: {"ë”ëŸ¬ì›€" if is_dirty else "ê¹¨ë—í•¨"}')
            return is_dirty
        else:
            self.get_logger().error('âŒ ì˜¤ì—¼ë„ íŒë‹¨ ì‹¤íŒ¨.')
            return False

    # âœ… ì›ì  ë³µê·€ ì„œë¹„ìŠ¤ í˜¸ì¶œ
    def call_go_home_service(self):
        if not self.go_home_client.wait_for_service(timeout_sec=3.0):
            self.get_logger().error('âŒ ì›ì  ë³µê·€ ì„œë¹„ìŠ¤ ì—°ê²° ì‹¤íŒ¨.')
            return

        request = Trigger.Request()
        future = self.go_home_client.call_async(request)
        rclpy.spin_until_future_complete(self, future)

        if future.result() is not None:
            self.get_logger().info(f'ğŸ ì›ì  ë³µê·€ ì™„ë£Œ: {future.result().message}')
        else:
            self.get_logger().error('âŒ ì›ì  ë³µê·€ ìš”ì²­ ì‹¤íŒ¨.')


def main(args=None):
    rclpy.init(args=args)
    node = TableManagerNode()
    rclpy.spin(node)
    node.destroy_node()
    rclpy.shutdown()
